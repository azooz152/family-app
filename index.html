<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <title>AZOOZ TV Receiver</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* --- الأساسيات --- */
        :root {
            --hilal-blue: #0057b7;
            --overlay-bg: rgba(0, 0, 0, 0.85);
            --select-bg: #fff;
            --text-color: #fff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Tahoma, sans-serif; user-select: none; outline: none; }

        body {
            background: #000;
            height: 100vh; width: 100vw; overflow: hidden; color: white;
        }

        /* --- مانع السكون (فيديو مخفي) --- */
        #wakeLockVideo {
            position: absolute; width: 1px; height: 1px; opacity: 0.01; pointer-events: none;
        }

        /* --- مشغل الفيديو (الخلفية الدائمة) --- */
        #video-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            background: black;
        }
        video { width: 100%; height: 100%; object-fit: cover; } /* ملء الشاشة */

        /* --- واجهة الرسيفر (Overlay) --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            display: flex; /* يظهر المحتوى */
            pointer-events: none; /* يسمح بالضغط على الفيديو إذا كانت الواجهة مخفية */
        }

        /* --- القائمة الجانبية (مثل الرسيفر) --- */
        .sidebar {
            width: 350px; height: 100%; 
            background: linear-gradient(to right, rgba(0,0,0,0.95), rgba(0,0,0,0.8));
            border-left: 2px solid var(--hilal-blue);
            display: flex; flex-direction: column;
            transform: translateX(0); transition: transform 0.3s ease;
            pointer-events: auto; /* تفعيل اللمس/الريموت هنا */
            padding-top: 20px;
        }

        .hidden-sidebar { transform: translateX(100%); } /* إخفاء القائمة */

        /* --- الهيدر داخل القائمة --- */
        .sidebar-header {
            padding: 0 20px 20px 20px; border-bottom: 1px solid #444;
            text-align: center;
        }
        .logo { color: var(--hilal-blue); font-size: 28px; font-weight: 900; text-shadow: 1px 1px 0 #fff; margin-bottom: 5px;}
        .status { font-size: 12px; color: #0f0; }

        /* --- قائمة العناصر --- */
        .list-area {
            flex: 1; overflow-y: auto; padding: 10px;
        }

        .item {
            padding: 15px 10px; margin-bottom: 5px;
            border-bottom: 1px solid #333; cursor: pointer;
            font-size: 16px; color: #ccc; text-align: right;
            border-radius: 5px; transition: 0.2s;
        }

        /* التركيز (بالريموت) */
        .item:focus, .item:hover {
            background: var(--hilal-blue); color: white;
            padding-right: 20px; /* حركة بسيطة */
            font-weight: bold; border-left: 5px solid white;
            box-shadow: 0 0 10px var(--hilal-blue);
        }

        /* العنصر النشط حالياً */
        .active-channel { color: var(--hilal-blue); font-weight: bold; }

        /* --- رسالة التحميل --- */
        #loader {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;
            z-index: 20; display: none; text-align: center;
            border: 2px solid var(--hilal-blue);
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #fff; border-top: 4px solid var(--hilal-blue);
            border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px auto;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- معلومات القناة (تظهر وتختفي) --- */
        #info-bar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 10px 30px; border-radius: 50px;
            border: 1px solid var(--hilal-blue); color: white; font-size: 20px;
            display: none; pointer-events: none;
        }

    </style>
</head>
<body>

    <video id="wakeLockVideo" playsinline loop muted autoplay>
        <source src="data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAAGF21kYXQAAAYUBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAABBcbW9vdgAAAGxtdmhkAAAAAAAAAAAAAAAAAAAD6AAAA+gAAQAAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAzB0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAABAAAAAAAAA+gAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAVoAAAAAAgAAAAAAAAAAAAQAAB5ibWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAAD6AAAA+gAAAAAAAEAAAAhaGRscgAAAAAAAAAAdmlkZQAAAAAAAAAAAAAAAFZpZGVvSGFuZGxlcgAAAB5WbWluZgAAAAF2bWhkAAAAAAACAAAAhZGluZgAAABRkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAAEcbXN0YQAAABhzdGtsAAAAAAAAAAEAAAIIAAAAAgAAAZdzdHNkAAAAAAAAAAEAAABfYXZjMQAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAVoACABIAAAASAAAAABAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAALWF2Y0MBQsAN/+EAFWdCwA3ZAsTsBEAAAPpAADqY8uFiAAAAAWhvcZyDAAAAAxBiaXRhAAAABgAAAAABhHBiYXQAAAAYYnJ0cgAAABAAAAPoAAAD6AAAABhzdHRzAAAAAAAAAAEAAAACAAAD6AAAABRzdHNzAAAAAAAAAAEAAAABAAAAHHN0c2MAAAAAAAAAAQAAAAEAAAACAAAAAQAAABRzdHN6AAAAAAAAAAAAAAACAAAD6AAAABRzdGNvAAAAAAAAAAEAAAYXAAAAYXVkdGEAAABXbWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpYQAAAAAAAAAAAAAAAAAAAAAipGlsaXQAAAAaZGF0YQAAAAEAAAAAZW5jb2RlZCBieQAAACBlbmNvZGVyAAAAABAAAABMYXZmNTguMjkuMTAw" type="video/mp4">
    </video>

    <div id="video-container">
        <video id="mainPlayer" autoplay></video>
    </div>

    <div id="ui-layer">
        
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="logo">AZOOZ TV</div>
                <div class="status" id="connection-status">متصل <i class="fas fa-check"></i></div>
                <div style="font-size:12px; color:#aaa; margin-top:5px;">اضغط <span style="color:#00e5ff">[رجوع]</span> للعودة للأقسام</div>
            </div>

            <div id="list-container" class="list-area">
                </div>
        </div>

    </div>

    <div id="info-bar">مرحباً بك في AZOOZ TV</div>

    <div id="loader">
        <div class="spinner"></div>
        <div id="loader-text">جاري الاتصال...</div>
    </div>

    <script>
        // --- الإعدادات ---
        const CONFIG = {
            host: "http://aseaf1.me:8080",
            user: "292737757579",
            pass: "196384823579"
        };

        // حالة التطبيق
        let appState = {
            level: 'categories', // categories, channels
            currentCategoryType: 'live', // live, movie, series
            lastCategoryId: null,
            menuVisible: true
        };

        // العناصر
        const sidebar = document.getElementById('sidebar');
        const listContainer = document.getElementById('list-container');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const player = document.getElementById('mainPlayer');
        const infoBar = document.getElementById('info-bar');

        // عند البدء
        window.onload = function() {
            loadCategories('live'); // البدء بالأقسام المباشرة
            // تشغيل فيديو منع السكون
            document.getElementById('wakeLockVideo').play().catch(e => console.log("WakeLock Autoplay blocked"));
        };

        // --- دوال الاتصال (مع البروكسي) ---
        async function fetchAPI(action, params = '') {
            showLoader(true);
            const originalUrl = `${CONFIG.host}/player_api.php?username=${CONFIG.user}&password=${CONFIG.pass}&action=${action}${params}`;
            // استخدام بروكسي لتخطي الحظر
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(originalUrl)}`;

            try {
                const res = await fetch(proxyUrl);
                if (!res.ok) throw new Error();
                const data = await res.json();
                showLoader(false);
                return data;
            } catch (e) {
                showLoader(false);
                showInfo("خطأ في الاتصال! حاول مجدداً");
                return [];
            }
        }

        // --- إدارة القوائم ---
        
        // 1. تحميل الأقسام (الرئيسية)
        async function loadCategories(type) {
            appState.level = 'categories';
            appState.currentCategoryType = type;
            listContainer.innerHTML = ''; // تنظيف

            // إضافة أزرار التنقل العلوية
            const navDiv = document.createElement('div');
            navDiv.style.marginBottom = "15px";
            navDiv.style.textAlign = "center";
            navDiv.innerHTML = `
                <button onclick="loadCategories('live')" style="padding:5px 10px; background:${type=='live'? 'var(--hilal-blue)':'#333'}; color:white; border:none; border-radius:4px;">قنوات</button>
                <button onclick="loadCategories('movie')" style="padding:5px 10px; background:${type=='movie'? 'var(--hilal-blue)':'#333'}; color:white; border:none; border-radius:4px;">أفلام</button>
                <button onclick="loadCategories('series')" style="padding:5px 10px; background:${type=='series'? 'var(--hilal-blue)':'#333'}; color:white; border:none; border-radius:4px;">مسلسلات</button>
            `;
            listContainer.appendChild(navDiv);

            // تحديد الـ Action
            let action = 'get_live_categories';
            if(type === 'movie') action = 'get_vod_categories';
            if(type === 'series') action = 'get_series_categories';

            const data = await fetchAPI(action);

            if(data.length === 0) {
                listContainer.innerHTML += "<div style='text-align:center; margin-top:20px; color:#777;'>لا توجد أقسام</div>";
                return;
            }

            // رسم الأقسام
            data.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'item';
                div.tabIndex = 0; // للريموت
                div.innerText = cat.category_name || cat.name;
                div.onclick = () => loadChannels(cat.category_id);
                // دعم زر OK في الريموت
                div.onkeydown = (e) => { if(e.key === 'Enter') loadChannels(cat.category_id); };
                listContainer.appendChild(div);
            });
            
            focusFirstItem();
        }

        // 2. تحميل القنوات/المحتوى
        async function loadChannels(catId) {
            appState.lastCategoryId = catId;
            appState.level = 'channels';
            listContainer.innerHTML = ''; // تنظيف

            let action = 'get_live_streams';
            if(appState.currentCategoryType === 'movie') action = 'get_vod_streams';
            if(appState.currentCategoryType === 'series') action = 'get_series';

            const data = await fetchAPI(action, `&category_id=${catId}`);

            if(data.length === 0) {
                showInfo("هذا القسم فارغ");
                goBack(); // العودة للأقسام
                return;
            }

            // رسم القنوات
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item';
                div.tabIndex = 0;
                div.innerText = item.name;
                
                let streamId = item.stream_id || item.series_id;
                let ext = item.container_extension || 'ts';
                if(appState.currentCategoryType === 'live') ext = 'm3u8';

                div.onclick = () => playChannel(streamId, ext, item.name);
                div.onkeydown = (e) => { if(e.key === 'Enter') playChannel(streamId, ext, item.name); };
                
                listContainer.appendChild(div);
            });

            focusFirstItem();
        }

        // --- المشغل ---
        function playChannel(id, ext, name) {
            let url = "";
            if(appState.currentCategoryType === 'live') {
                url = `${CONFIG.host}/live/${CONFIG.user}/${CONFIG.pass}/${id}.${ext}`;
            } else if (appState.currentCategoryType === 'movie') {
                url = `${CONFIG.host}/movie/${CONFIG.user}/${CONFIG.pass}/${id}.${ext}`;
            } else {
                url = `${CONFIG.host}/series/${CONFIG.user}/${CONFIG.pass}/${id}.${ext}`;
            }

            // تشغيل HLS
            if (Hls.isSupported() && appState.currentCategoryType === 'live') {
                if(window.hls) window.hls.destroy(); // تدمير السابق
                window.hls = new Hls();
                window.hls.loadSource(url);
                window.hls.attachMedia(player);
                window.hls.on(Hls.Events.MANIFEST_PARSED, function() { player.play(); });
            } else {
                player.src = url;
                player.play();
            }

            showInfo(`جاري تشغيل: ${name}`);
            
            // إخفاء القائمة تلقائياً ليعمل كـ Full Screen
            toggleMenu(false);
        }

        // --- أدوات التحكم والواجهة ---
        
        function toggleMenu(show) {
            appState.menuVisible = show;
            if(show) {
                sidebar.classList.remove('hidden-sidebar');
                // محاولة التركيز على القائمة
                setTimeout(focusFirstItem, 100);
            } else {
                sidebar.classList.add('hidden-sidebar');
                player.focus(); // التركيز على الفيديو
            }
        }

        function focusFirstItem() {
            const first = listContainer.querySelector('.item');
            if(first) first.focus();
        }

        function showLoader(state) {
            loader.style.display = state ? 'block' : 'none';
        }

        function showInfo(text) {
            infoBar.innerText = text;
            infoBar.style.display = 'block';
            setTimeout(() => { infoBar.style.display = 'none'; }, 3000);
        }

        // زر الرجوع في النظام (Logic)
        function goBack() {
            if (!appState.menuVisible) {
                // إذا القائمة مخفية -> أظهرها
                toggleMenu(true);
            } else {
                // إذا القائمة ظاهرة
                if (appState.level === 'channels') {
                    // ارجع للأقسام
                    loadCategories(appState.currentCategoryType);
                } else {
                    // نحن في الأقسام الرئيسية -> لا تفعل شيئاً أو أظهر رسالة خروج
                    showInfo("أنت في القائمة الرئيسية");
                }
            }
        }

        // --- التعامل مع أزرار الريموت ---
        document.addEventListener('keydown', function(e) {
            const key = e.key;
            // أكواد الرجوع الشائعة في التلفزيونات
            if (key === 'Backspace' || key === 'Escape' || e.keyCode === 10009 || e.keyCode === 27 || e.keyCode === 8) {
                e.preventDefault(); // منع الخروج من التطبيق
                goBack();
            }
            
            // إذا ضغط OK والفائمة مخفية -> أظهر القائمة
            if ((key === 'Enter' || e.keyCode === 13) && !appState.menuVisible) {
                toggleMenu(true);
            }
        });

    </script>
</body>
</html>
