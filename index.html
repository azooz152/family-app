<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Family Super App</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            font-family: 'Cairo', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; background-color: #000;
            overscroll-behavior-y: none;
        }

        /* Ø§Ù„Ø®Ù„ÙÙŠØ© */
        .bg-base-family {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('home.png'); 
            background-size: cover; background-position: center;
            z-index: -10; filter: brightness(0.9);
        }
        
        .bg-overlay-girl {
            position: fixed; bottom: 0; left: 0; width: 65%; height: 75%;
            background-image: url('girl.png'); 
            background-size: contain; background-repeat: no-repeat; background-position: bottom left;
            z-index: -5; opacity: 1;
            -webkit-mask-image: linear-gradient(to right, black 20%, transparent 100%);
            mask-image: linear-gradient(to right, black 20%, transparent 100%);
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.1); 
        }
        .login-box {
            background: rgba(255, 255, 255, 0.1); 
            padding: 45px 30px; border-radius: 35px;
            width: 85%; max-width: 350px; text-align: center; 
            border: 1px solid rgba(255, 255, 255, 0.3); 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        .login-avatar {
            width: 110px; height: 110px; margin: 0 auto 25px; border-radius: 50%; 
            border: 3px solid rgba(255,255,255,0.5);
            background-image: url('girl.png'); background-size: cover; background-position: top center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .login-title { font-size: 26px; font-weight: 900; margin-bottom: 30px; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .login-input {
            width: 100%; padding: 15px; margin-bottom: 15px; 
            background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px; 
            color: white; text-align: center; outline: none; font-size: 16px; font-weight: bold;
        }
        .login-input::placeholder { color: #ddd; }
        .login-btn {
            width: 100%; padding: 15px; margin-top: 10px;
            background: linear-gradient(135deg, #00deb6, #008069);
            color: white; border: none; border-radius: 15px; font-size: 18px; font-weight: 900; cursor: pointer;
            box-shadow: 0 10px 20px rgba(0, 222, 182, 0.2);
        }

        /* Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        #contact-list { display: none; flex-direction: column; height: 100%; z-index: 50; position: relative; }
        .app-header {
            background: rgba(0, 128, 105, 0.85); color: white; padding: 15px 20px; padding-top: 45px; 
            font-size: 22px; font-weight: 900; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(10px);
        }
        #dynamic-contacts { flex: 1; overflow-y: auto; padding-top: 15px; }
        .contact-item {
            display: flex; align-items: center; padding: 15px; cursor: pointer; 
            background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2);
            border-left: 5px solid #00deb6; margin: 10px 15px; border-radius: 20px;
            backdrop-filter: blur(10px); box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .contact-item:active { transform: scale(0.97); background: rgba(255,255,255,0.25); }
        .avatar { width: 60px; height: 60px; border-radius: 50%; background: #ddd; margin-left: 15px; background-size: cover; border: 2px solid rgba(255,255,255,0.9); flex-shrink: 0; }
        .info { flex: 1; }
        .name { font-weight: 900; font-size: 19px; margin-bottom: 5px; color: #fff; text-shadow: 0 2px 5px black; }
        .last-msg { color: #f0f0f0; font-weight: normal; font-size: 14px; text-shadow: 0 1px 3px black; }
        .time { font-size: 12px; color: #ddd; margin-right: auto; }

        /* Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ */
        .games-banner-container { padding: 20px 15px 40px 15px; background: transparent; margin-top: auto; }
        .games-banner {
            padding: 30px;
            background: url('https://media.giphy.com/media/26tn33ai009QWJWplu/giphy.gif');
            background-size: cover; background-position: center;
            border-radius: 25px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(0, 222, 182, 0.6); 
            border: 2px solid #00deb6; position: relative; overflow: hidden; text-align: center;
        }
        .games-banner::before { content: ''; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 1; }
        .game-text-main { 
            color: #00deb6; font-weight: 900; font-size: 28px; z-index: 2; 
            text-shadow: 0 0 15px #00deb6; margin-bottom: 5px; font-family: 'Cairo', sans-serif;
        }
        .game-text-sub { color: #fff; font-size: 14px; z-index: 2; font-weight: bold; text-shadow: 0 2px 5px black; }

        #games-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a2e; z-index: 200; flex-direction: column; }
        .game-header { padding: 15px; padding-top: 45px; background: #111; color: white; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #00deb6; }
        .game-categories { display: flex; overflow-x: auto; padding: 15px; gap: 10px; background: #222; }
        .cat-btn { padding: 8px 20px; background: rgba(255,255,255,0.1); color: white; border-radius: 20px; white-space: nowrap; border: 1px solid #555; cursor: pointer; font-weight: bold; }
        .cat-btn.active { background: #00deb6; color: black; border-color: #00deb6; }
        .games-list { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding-bottom: 60px; }
        .game-card { background: #2a2a3e; border-radius: 20px; overflow: hidden; cursor: pointer; border: 1px solid #444; transition: 0.2s; position: relative; height: 160px; }
        .game-img { height: 100%; width: 100%; background-size: cover; background-position: center; }
        .game-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, black, transparent); padding: 10px; color: white; font-weight: bold; text-align: center; }

        /* Ø§Ù„Ø´Ø§Øª */
        #chat-screen { display: none; flex-direction: column; height: 100%; position: fixed; top: 0; left: 0; width: 100%; background-color: rgba(0,0,0,0.65); z-index: 100; }
        .chat-header { background-color: rgba(0, 128, 105, 0.95); color: white; padding: 5px 10px; padding-top: 45px; display: flex; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 10; min-height: 90px; }
        .back-btn { margin-left: 5px; cursor: pointer; padding: 10px; font-size: 24px; display: flex; align-items: center; }
        .header-avatar { width: 45px; height: 45px; border-radius: 50%; background-size: cover; margin-left: 10px; background-color: #ddd; border: 2px solid white; }
        .header-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .header-name { font-weight: bold; font-size: 18px; margin-bottom: 2px; }
        .header-status { font-size: 13px; opacity: 0.9; }
        .header-actions i { margin-right: 25px; font-size: 24px; cursor: pointer; color: white; }
        .messages-area { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; z-index: 5; }
        .msg { max-width: 85%; padding: 10px 15px; border-radius: 15px; font-size: 16px; position: relative; box-shadow: 0 3px 8px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .msg-in { align-self: flex-start; background: #fff; border-radius: 0 15px 15px 15px; color: #000; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-radius: 15px 0 15px 15px; color: #000; }
        .msg-meta { font-size: 11px; color: #666; margin-top: 5px; align-self: flex-end; display: flex; align-items: center; }
        .ticks { margin-right: 4px; color: #53bdeb; font-size: 14px; }
        .chat-footer { background: #f0f2f5; padding: 5px 10px; display: flex; align-items: center; min-height: 70px; padding-bottom: max(25px, env(safe-area-inset-bottom)); position: relative; z-index: 10; border-top: 1px solid #ccc; }
        .footer-icon { font-size: 26px; color: #54656f; padding: 10px; cursor: pointer; transition: 0.2s; }
        .input-container { flex: 1; background: white; border-radius: 25px; padding: 10px 15px; margin: 0 10px; display: flex; align-items: center; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .chat-input { flex: 1; border: none; outline: none; font-size: 17px; width: 100%; background: transparent; text-align: right; }
        .send-btn { background-color: #008069; color: white; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 5px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        #admin-panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f2f2f7; z-index: 300; flex-direction: column; }
        .admin-header { background: #333; color: white; padding: 15px; padding-top: 40px; font-weight: bold; display: flex; justify-content: space-between; }
        .admin-content { flex: 1; padding: 20px; overflow-y: auto; }
        .user-row { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .delete-btn { background: #ff3b30; color: white; padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; }
        .add-user-form { background: white; padding: 20px; border-radius: 15px; margin-top: 20px; }

        /* ğŸ”¥ Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…ØµØ­Ø­Ø© */
        #video-container { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: #000; z-index: 99999; display: none; 
        }
        /* ØªØ¹Ø¯ÙŠÙ„ Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù„ÙŠÙƒÙˆÙ† Ø¸Ø§Ù‡Ø±Ø§Ù‹ */
        .exit-call-btn {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            background: red; color: white; padding: 15px 30px; border-radius: 30px;
            font-weight: bold; z-index: 100000; cursor: pointer; border: 2px solid white;
        }

        #game-frame-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; z-index: 300; flex-direction: column; }
        .game-toolbar { height: 85px; padding-top: 35px; background: #111; display: flex; align-items: center; justify-content: space-between; padding-left: 15px; padding-right: 15px; color: #00deb6; border-bottom: 1px solid #333; }
        .close-game-btn { background: #ff3b30; color: white; padding: 8px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        iframe { width: 100%; height: 100%; border: none; background: #fff; }
        
        #adnan-game-ui, #piano-game-ui, #coloring-game-ui, #xo-game-ui { display: none; flex-direction: column; height: 100%; align-items: center; justify-content: center; }
        .surah-btn { width: 100%; padding: 18px; margin: 10px 0; background: #00acc1; color: white; border: none; border-radius: 20px; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        #piano-game-ui .key { width: 45px; height: 160px; background: white; border-radius: 0 0 8px 8px; margin: 0 2px;}
        #piano-game-ui .key.black { height: 100px; width: 35px; margin-left: -20px; margin-right: -20px; z-index: 2; position: relative; background: black;}
        #coloring-game-ui .color-dot { width: 35px; height: 35px; border-radius: 50%; border: 3px solid #ccc; cursor: pointer; margin: 0 5px;}
        #xo-game-ui .xo-cell { width: 100px; height: 100px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 60px; font-weight: bold; border: 3px solid #00deb6; border-radius: 15px; cursor: pointer; margin: 5px;}

        #file-input, #camera-input, audio { display: none; }
    </style>
</head>
<body>

    <div class="bg-base-family"></div>
    <div class="bg-overlay-girl"></div>
    <audio id="msg-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>

    <div id="login-screen">
        <div class="login-box">
            <div class="login-avatar"></div>
            <div class="login-title">FAMILY CONNECT</div>
            <input type="text" id="login-user" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="login-pass" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="login-btn" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="contact-list">
        <div class="app-header">
            <span>FamilyApp</span>
            <div><i class="fas fa-sign-out-alt" onclick="logout()" style="margin-left:15px; cursor:pointer"></i><i class="fas fa-cog" onclick="openAdmin()" style="cursor:pointer"></i></div>
        </div>
        <div id="dynamic-contacts"></div>
        <div class="games-banner-container">
            <div class="games-banner" onclick="openGames()">
                <div>
                    <div class="game-text-main">Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</div>
                    <div class="game-text-sub">ØªØ­Ø¯Ù‰ Ù…Ø¹ Ø¯ÙŠØ§Ù„Ø§ØŒ ÙÙ‡Ø¯ØŒ Ø¹Ø§ÙŠØ¶Ù‡ØŒ ÙˆØ¯ÙŠÙ†Ø§ â¤ï¸</div>
                </div>
            </div>
        </div>
    </div>

    <div id="games-screen">
        <div class="game-header"><span>ğŸ® Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</span><span onclick="closeGames()" style="color:#ff3b30; font-size:24px; cursor:pointer;"><i class="fas fa-times-circle"></i></span></div>
        <div class="game-categories">
            <button class="cat-btn active" onclick="filterGames('all')">Ø§Ù„ÙƒÙ„</button>
            <button class="cat-btn" onclick="filterGames('family')">Ø¬Ù…Ø§Ø¹ÙŠ</button>
            <button class="cat-btn" onclick="filterGames('dina')">Ø¯ÙŠÙ†Ø§</button>
        </div>
        <div class="games-list" id="games-grid"></div>
    </div>

    <div id="game-frame-container">
        <div class="game-toolbar"><span id="game-title">Ù„Ø¹Ø¨</span><div class="close-game-btn" onclick="closeGameFrame()">Ø®Ø±ÙˆØ¬</div></div>
        <iframe id="game-frame" src=""></iframe>
        <div id="adnan-game-ui" style="background:#e0f7fa; padding:20px"><div class="adnan-char" style="width:130px;height:130px;background:url('https://play-lh.googleusercontent.com/8Qn9a9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9') center/contain no-repeat;border-radius:50%;border:5px solid #00acc1;background-color:white;margin-bottom:20px"></div><button class="surah-btn" onclick="playAudio('https://server7.mp3quran.net/basit/Almusshaf_Al-Mojawwad/001.mp3')"><span>Ø§Ù„ÙØ§ØªØ­Ø©</span><i class="fas fa-play"></i></button></div>
        <div id="piano-game-ui" style="background:#222; justify-content:center"><div class="piano-keys" style="display:flex"><div class="key" onclick="playNote(261)"></div><div class="key black" onclick="playNote(277)"></div><div class="key" onclick="playNote(293)"></div><div class="key black" onclick="playNote(311)"></div><div class="key" onclick="playNote(329)"></div></div></div>
        <div id="coloring-game-ui" style="background:white"><canvas id="drawing-canvas" style="flex:1;width:100%"></canvas><div class="colors-bar" style="height:60px;display:flex;justify-content:center;background:#eee"><div class="color-dot" style="background:red" onclick="setColor('red')"></div><div class="color-dot" style="background:blue" onclick="setColor('blue')"></div><div class="color-dot" style="background:white;border:2px solid black" onclick="setColor('white')"></div></div></div>
        <div id="xo-game-ui" style="background:#1a1a2e;color:white"><div class="xo-board" id="xo-board" style="display:grid;grid-template-columns:repeat(3,100px);gap:10px"></div><button class="login-btn" style="width:auto;margin-top:20px" onclick="initXO()">Ø¥Ø¹Ø§Ø¯Ø©</button></div>
    </div>

    <div id="admin-panel"><div class="admin-header"><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span><span onclick="closeAdmin()">âŒ</span></div><div class="admin-content"><h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†:</h3><div id="users-list"></div><div class="add-user-form"><input type="text" id="new-name" class="login-input" style="background:#fff; color:black" placeholder="Ø§Ù„Ø§Ø³Ù…"><input type="text" id="new-user" class="login-input" style="background:#fff; color:black" placeholder="ÙŠÙˆØ²Ø±"><input type="text" id="new-pass" class="login-input" style="background:#fff; color:black" placeholder="Ø¨Ø§Ø³ÙˆØ±Ø¯"><select id="new-role" class="login-input" style="background:#fff; color:black"><option value="user">Ù…Ø³ØªØ®Ø¯Ù…</option><option value="admin">Ù…Ø¯ÙŠØ±</option></select><button class="login-btn" onclick="addUser()">Ø¥Ø¶Ø§ÙØ©</button></div></div></div>

    <input type="file" id="file-input" onchange="handleFileSelect(this)">
    <input type="file" id="camera-input" accept="image/*" capture="environment" onchange="handleFileSelect(this)">

    <div id="chat-screen">
        <div class="chat-header">
            <div class="back-btn" onclick="closeChat()"><i class="fas fa-arrow-right"></i></div>
            <div id="chat-header-avatar" class="header-avatar"></div>
            <div class="header-info"><div id="chat-name" class="header-name"></div><div class="header-status">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</div></div>
            <div class="header-actions">
                <i class="fas fa-video" onclick="startCall(true)"></i>
                <i class="fas fa-phone" onclick="startCall(false)"></i>
            </div>
        </div>
        <div class="messages-area" id="msg-area"></div>
        <div class="chat-footer">
            <i class="fas fa-plus footer-icon" onclick="document.getElementById('file-input').click()"></i>
            <div class="input-container"><input type="text" class="chat-input" id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©"></div>
            <i class="fas fa-camera footer-icon" onclick="document.getElementById('camera-input').click()"></i>
            <i class="fas fa-microphone footer-icon" onclick="alert('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±')"></i>
            <div class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></div>
        </div>
    </div>

    <div id="video-container"></div>

    <script>
        const defaultUsers = [
            { name: "Ø¨Ø§Ø¨Ø§ (Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ²)", user: "admin", pass: "1234", role: "admin", avatar: "ğŸ‘¨ğŸ»", lastMsg: "âœ… ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨" },
            { name: "Ù…Ø§Ù…Ø§ (Ø¹Ø§ÙŠØ¶Ù‡)", user: "aida", pass: "1111", role: "user", avatar: "ğŸ‘©ğŸ»", lastMsg: "ÙˆÙŠÙ†ÙƒÙ…ØŸ" },
            { name: "ÙÙ‡Ø¯", user: "fahad", pass: "2222", role: "user", avatar: "ğŸ‘¦ğŸ»", lastMsg: "Ø£Ù„Ø¹Ø¨ ÙƒÙˆØ¯" },
            { name: "Ø¯ÙŠØ§Ù„Ø§", user: "diyala", pass: "3333", role: "user", avatar: "ğŸ‘±ğŸ»â€â™€ï¸", lastMsg: "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±" },
            { name: "Ø¯ÙŠÙ†Ø§", user: "dina", pass: "4444", role: "user", avatar: "ğŸ‘§ğŸ»", lastMsg: "â¤ï¸ Ø£Ø­Ø¨Ùƒ" }
        ];
        
        let users = JSON.parse(localStorage.getItem('familyUsers'));
        if (!users || users.length < 5) { users = defaultUsers; localStorage.setItem('familyUsers', JSON.stringify(users)); }
        let currentUser = null;

        const appID = 1737796508; 
        const serverSecret = "930ae2dcb4bc6bdd37cb5d00341bd5ea";

        window.onload = function() {
            const savedUser = JSON.parse(localStorage.getItem('currentUser'));
            if(savedUser) {
                currentUser = savedUser;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('contact-list').style.display = 'flex';
                renderContacts();
            }
        };

        function login() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            const foundUser = users.find(user => user.user === u && user.pass === p);
            if (foundUser) {
                currentUser = foundUser;
                localStorage.setItem('currentUser', JSON.stringify(foundUser));
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('contact-list').style.display = 'flex';
                renderContacts();
            } else { alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø®Ø·Ø£!"); }
        }
        function logout() { localStorage.removeItem('currentUser'); location.reload(); }
        function renderContacts() {
            const list = document.getElementById('dynamic-contacts'); list.innerHTML = '';
            users.forEach(u => {
                if (u.user !== currentUser.user) {
                    list.innerHTML += `<div class="contact-item" onclick="openChat('${u.name}', '', '${u.avatar}')"><div class="avatar">${u.avatar}</div><div class="info"><div class="name">${u.name}</div><div class="last-msg">${u.lastMsg || 'Ù…Ø±Ø­Ø¨Ø§Ù‹'}</div></div><div class="time">Ø§Ù„Ø¢Ù†</div></div>`;
                }
            });
        }

        function startCall(isVideo) { 
            const videoContainer = document.getElementById('video-container'); 
            videoContainer.style.display = 'block'; 
            
            // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø®Ø±ÙˆØ¬ ÙŠØ¯ÙˆÙŠ
            const exitBtn = document.createElement('div');
            exitBtn.className = 'exit-call-btn';
            exitBtn.innerText = 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© âŒ';
            exitBtn.onclick = () => { location.reload(); }; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ù‚Ø³Ø±ÙŠ
            videoContainer.appendChild(exitBtn);

            const roomID = "Family_Room_Unified"; // ØºØ±ÙØ© Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹
            const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(appID, serverSecret, roomID, currentUser.user + Date.now(), currentUser.name);
            const zp = ZegoUIKitPrebuilt.create(kitToken);
            
            zp.joinRoom({ 
                container: videoContainer, 
                showPreJoinView: false, // Ø¯Ø®ÙˆÙ„ ÙÙˆØ±ÙŠ
                scenario: { mode: ZegoUIKitPrebuilt.GroupCall }, 
                turnOnCameraWhenJoining: isVideo,
                turnOnMicrophoneWhenJoining: true,
                showLeaveRoomConfirmDialog: false,
                onLeaveRoom: () => { 
                    videoContainer.style.display = 'none'; 
                    videoContainer.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
                }
            });
        }

        const games = [
            { id: "smash", title: "Ø³Ø¨Ø§Ù‚ Ø³ÙŠØ§Ø±Ø§Øª", cat: "family", type: "external", url: "https://smashkarts.io/", img: "https://smashkarts.io/images/icon-192.png", badge: "Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†" },
            { id: "krunker", title: "Ø­Ø±Ø¨ (Krunker)", cat: "family", type: "external", url: "https://krunker.io/?game=BHG", img: "https://assets.krunker.io/promo/og.png", badge: "Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†" },
            { id: "adnan", title: "Ø¹Ø¯Ù†Ø§Ù† (Ù‚Ø±Ø¢Ù†)", cat: "dina", type: "internal", action: "adnan", img: "https://play-lh.googleusercontent.com/8Qn9a9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9q9", badge: "ØªØ¹Ù„ÙŠÙ…ÙŠ" },
            { id: "xo", title: "ØªØ­Ø¯ÙŠ X O", cat: "family", type: "internal", action: "xo", img: "https://cdn-icons-png.flaticon.com/512/566/566294.png", badge: "Ø¬Ø¯ÙŠØ¯" },
            { id: "piano", title: "Ø¨ÙŠØ§Ù†Ùˆ", cat: "dina", type: "internal", action: "piano", img: "https://cdn-icons-png.flaticon.com/512/3233/3233483.png", badge: "Ø£Ø·ÙØ§Ù„" },
            { id: "coloring", title: "ØªÙ„ÙˆÙŠÙ†", cat: "dina", type: "internal", action: "coloring", img: "https://cdn-icons-png.flaticon.com/512/2919/2919652.png", badge: "Ø£Ø·ÙØ§Ù„" }
        ];

        function openGames() { document.getElementById('games-screen').style.display = 'flex'; filterGames('all'); }
        function closeGames() { document.getElementById('games-screen').style.display = 'none'; closeGameFrame(); }
        function filterGames(cat) {
            const grid = document.getElementById('games-grid'); grid.innerHTML = '';
            const filtered = cat === 'all' ? games : games.filter(g => g.cat === cat);
            filtered.forEach(g => {
                grid.innerHTML += `<div class="game-card" onclick="launchGame('${g.id}')">${g.badge ? `<div style="position:absolute;top:10px;right:10px;background:#00deb6;color:black;padding:2px 8px;border-radius:5px;font-size:10px;font-weight:bold">${g.badge}</div>` : ''}<div class="game-img" style="background-image: url('${g.img}')"></div><div class="game-overlay">${g.title}</div></div>`;
            });
        }
        function launchGame(id) {
            const game = games.find(g => g.id === id);
            document.getElementById('game-frame-container').style.display = 'flex';
            document.getElementById('game-title').innerText = game.title;
            const uis = ['adnan-game-ui', 'piano-game-ui', 'coloring-game-ui', 'xo-game-ui'];
            uis.forEach(u => document.getElementById(u).style.display = 'none');
            document.getElementById('game-frame').style.display = 'none';
            if (game.type === 'external') {
                document.getElementById('game-frame').style.display = 'block';
                document.getElementById('game-frame').src = game.url;
            } else {
                if(game.action) document.getElementById(game.action + '-game-ui').style.display = 'flex';
                if(game.action === 'coloring') initColoring();
                if(game.action === 'xo') initXO();
            }
        }
        function closeGameFrame() { document.getElementById('game-frame-container').style.display = 'none'; document.getElementById('game-frame').src = ""; }

        function playAudio(url) { const a = new Audio(url); a.play(); }
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playNote(f) { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sine'; o.frequency.value=f; g.gain.setValueAtTime(0.5, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+1); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+1); }
        let canvas, ctx, color = 'red';
        function initColoring() { canvas = document.getElementById('drawing-canvas'); ctx = canvas.getContext('2d'); canvas.width = window.innerWidth; canvas.height = window.innerHeight - 60; ctx.fillStyle='white'; ctx.fillRect(0,0,canvas.width,canvas.height); let drawing = false; const draw = (e) => { if(!drawing) return; ctx.lineWidth = 5; ctx.lineCap = 'round'; ctx.strokeStyle = color; const x = e.touches ? e.touches[0].clientX : e.clientX; const y = e.touches ? e.touches[0].clientY : e.clientY; ctx.lineTo(x, y - 50); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y - 50); }; canvas.onmousedown=(e)=>{drawing=true;draw(e)}; canvas.onmouseup=()=>{drawing=false;ctx.beginPath()}; canvas.onmousemove=draw; canvas.ontouchstart=(e)=>{drawing=true;draw(e)}; canvas.ontouchend=()=>{drawing=false;ctx.beginPath()}; canvas.ontouchmove=draw; }
        function setColor(c) { color = c; }
        let board = Array(9).fill(''); let player = 'X';
        function initXO() { board.fill(''); player = 'X'; document.getElementById('xo-board').innerHTML=''; board.forEach((_,i)=>{ const c=document.createElement('div'); c.className='xo-cell'; c.onclick=()=>{ if(board[i]) return; board[i]=player; c.innerText=player; player=player==='X'?'O':'X'; }; document.getElementById('xo-board').appendChild(c); }); }

        function openChat(name, bg, emoji) { document.getElementById('contact-list').style.display = 'none'; document.getElementById('chat-screen').style.display = 'flex'; document.getElementById('chat-name').innerText = name; document.getElementById('chat-header-avatar').innerText = emoji; }
        function closeChat() { document.getElementById('chat-screen').style.display = 'none'; document.getElementById('contact-list').style.display = 'flex'; }
        
        function handleFileSelect(input) { if (input.files && input.files[0]) { const area = document.getElementById('msg-area'); area.innerHTML += `<div class="msg msg-out"><div>ğŸ“· ØµÙˆØ±Ø©</div><img src="${URL.createObjectURL(input.files[0])}" class="msg-img"><div class="msg-meta">Ø§Ù„Ø¢Ù†<span class="ticks">âœ“</span></div></div>`; area.scrollTop = area.scrollHeight; playSound(); } }
        
        function playSound() { const audio = document.getElementById('msg-sound'); audio.currentTime = 0; audio.play().catch(e => console.log(e)); }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            if(input.value.trim()) {
                const area = document.getElementById('msg-area');
                area.innerHTML += `<div class="msg msg-out"><div>${input.value}</div><div class="msg-meta">Ø§Ù„Ø¢Ù†<span class="ticks">âœ“</span></div></div>`;
                input.value = '';
                area.scrollTop = area.scrollHeight;
                playSound();
            }
        }

        function openAdmin() { if(currentUser.role!=='admin'){alert('Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·');return;} document.getElementById('admin-panel').style.display='flex'; renderAdminList(); }
        function closeAdmin() { document.getElementById('admin-panel').style.display='none'; }
        function renderAdminList() { const l=document.getElementById('users-list'); l.innerHTML=''; users.forEach((u,i)=>l.innerHTML+=`<div class="user-row"><div>${u.name}</div>${u.user!=='admin'?`<button class="delete-btn" onclick="deleteUser(${i})">Ø­Ø°Ù</button>`:''}</div>`); }
        function addUser() { const n=document.getElementById('new-name').value; const u=document.getElementById('new-user').value; const p=document.getElementById('new-pass').value; if(n&&u&&p){ users.push({name:n,user:u,pass:p,role:'user',avatar:'ğŸ‘¤',lastMsg:'Ø¬Ø¯ÙŠØ¯'}); localStorage.setItem('familyUsers',JSON.stringify(users)); renderAdminList(); renderContacts(); alert('ØªÙ…'); } }
        function deleteUser(i) { if(confirm('Ø­Ø°ÙØŸ')){ users.splice(i,1); localStorage.setItem('familyUsers',JSON.stringify(users)); renderAdminList(); renderContacts(); } }
    </script>
</body>
</html>
