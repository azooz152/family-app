<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <title>AZOOZ TV Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* --- ثيم الهلال الأزرق --- */
        :root {
            --hilal-blue: #0057b7; /* أزرق الهلال */
            --hilal-dark: #003d80;
            --bg-dark: #050505;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; user-select: none; outline: none; }

        body {
            background-image: url('home.png'); 
            background-size: cover; background-position: center; background-attachment: fixed;
            background-color: var(--bg-dark);
            height: 100vh; overflow: hidden; color: white;
        }

        body::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.75); z-index: -1;
        }

        /* --- نظام الشاشات --- */
        .screen {
            display: none; width: 100%; height: 100%;
            flex-direction: column; padding: 20px;
        }
        .active { display: flex; }

        /* --- الهيدر --- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 15px; border-bottom: 2px solid var(--hilal-blue);
            margin-bottom: 15px; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px;
        }
        .logo { font-size: 32px; font-weight: 900; color: var(--hilal-blue); text-shadow: 1px 1px 0 #fff; letter-spacing: 1px;}
        
        .back-btn { 
            font-size: 18px; color: white; background: var(--hilal-blue); 
            padding: 8px 25px; border-radius: 50px; cursor: pointer; display: none; 
            border: 2px solid white; font-weight: bold;
            box-shadow: 0 0 10px var(--hilal-blue);
        }
        .back-btn:hover { transform: scale(1.05); }

        /* --- الشبكة الرئيسية --- */
        .grid-container {
            display: flex; justify-content: center; align-items: center; align-content: center;
            flex-wrap: wrap; gap: 30px; height: 100%;
        }

        .card {
            width: 180px; height: 180px;
            background: rgba(20,20,20,0.8); border: 2px solid #555; border-radius: 20px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
        }

        .card i { font-size: 55px; margin-bottom: 15px; color: #fff; z-index: 2; transition: 0.3s;}
        .card span { font-size: 20px; font-weight: bold; color: #ccc; z-index: 2; }

        /* --- تصميم الهلال عند التحديد --- */
        .card:focus, .card:hover {
            transform: scale(1.1); 
            border-color: var(--hilal-blue);
            background-color: #fff; 
            box-shadow: 0 0 30px var(--hilal-blue);
            /* تأكد من رفع صورة hilal.png لتعمل الخلفية */
            background-image: url('hilal.png'); background-size: cover; background-position: center;
        }
        
        /* طبقة بيضاء شفافة لتوضيح النص فوق شعار الهلال */
        .card:focus::before, .card:hover::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.9); z-index: 1;
        }
        
        .card:focus i, .card:hover i { color: var(--hilal-blue); transform: scale(1.1); }
        .card:focus span, .card:hover span { color: var(--hilal-blue); text-shadow: 0 0 2px #000; }

        /* --- القوائم (القنوات) --- */
        .list-container {
            flex: 1; overflow-y: auto; padding: 10px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;
        }

        .list-item {
            background: rgba(30,30,30,0.8); padding: 15px; border-radius: 10px;
            text-align: center; cursor: pointer; border: 1px solid #444;
            color: #eee; font-weight: bold; font-size: 16px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            transition: 0.2s;
        }
        
        .list-item:focus, .list-item:hover {
            background: var(--hilal-blue); color: white; 
            transform: scale(1.05); border-color: white;
            box-shadow: 0 0 15px var(--hilal-blue);
        }

        /* --- المشغل --- */
        .player-container {
            flex: 1; display: flex; justify-content: center; align-items: center; background: black; border-radius: 10px; overflow: hidden; border: 2px solid #333;
        }
        video { width: 100%; height: 100%; }

        /* --- اللودر --- */
        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95);
            display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:9999;
        }
        .spinner {
            width:60px; height:60px; border:6px solid #fff; border-top:6px solid var(--hilal-blue);
            border-radius:50%; animation:spin 0.8s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <h3 style="margin-top:20px; color:var(--hilal-blue);">جاري الاتصال بالنظام...</h3>
    </div>

    <div id="home-screen" class="screen active">
        <div class="header">
            <div class="logo">AZOOZ TV</div>
            <div class="user-info" style="color:#aaa;"> <i class="fas fa-wifi" style="color:#0f0;"></i> متصل</div>
        </div>
        <div class="grid-container">
            <div class="card" tabindex="1" onclick="loadCategories('live')">
                <i class="fas fa-tv"></i> <span>القنوات</span>
            </div>
            <div class="card" tabindex="2" onclick="loadCategories('movie')">
                <i class="fas fa-film"></i> <span>الأفلام</span>
            </div>
            <div class="card" tabindex="3" onclick="loadCategories('series')">
                <i class="fas fa-video"></i> <span>المسلسلات</span>
            </div>
             <div class="card" tabindex="4" onclick="location.reload()">
                <i class="fas fa-sync"></i> <span>تحديث</span>
            </div>
        </div>
    </div>

    <div id="list-screen" class="screen">
        <div class="header">
            <div class="logo" style="font-size:24px;" id="list-title">القائمة</div>
            <div class="back-btn" style="display:block;" onclick="goBack()">رجوع <i class="fas fa-arrow-left"></i></div>
        </div>
        <div id="list-content" class="list-container"></div>
    </div>

    <div id="player-screen" class="screen">
        <div class="header">
            <div class="logo" style="font-size:18px;" id="player-title">مشغل الفيديو</div>
            <div class="back-btn" style="display:block;" onclick="stopPlayer()">إغلاق <i class="fas fa-times"></i></div>
        </div>
        <div class="player-container">
            <video id="videoPlayer" controls autoplay></video>
        </div>
    </div>

    <script>
        const CONFIG = {
            host: "http://aseaf1.me:8080",
            user: "292737757579",
            pass: "196384823579"
        };

        let currentLevel = 'home';
        let lastCategoryType = '';
        let hls = null;

        window.onload = function() {
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                document.querySelector('.card').focus(); 
            }, 1500);
        };

        // --- الجسر السحري (Proxy) لتخطي الحظر ---
        async function apiCall(action, params = '') {
            document.getElementById('loader').style.display = 'flex';
            
            // الرابط الأصلي
            const originalUrl = `${CONFIG.host}/player_api.php?username=${CONFIG.user}&password=${CONFIG.pass}&action=${action}${params}`;
            
            // استخدام جسر (Proxy) لتخطي مشكلة Mixed Content و CORS
            // نستخدم خدمة allorigins لأنها سريعة ومجانية
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(originalUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error("Server Response Error");
                const data = await response.json();
                document.getElementById('loader').style.display = 'none';
                return data;
            } catch (error) {
                document.getElementById('loader').style.display = 'none';
                console.error(error);
                alert("تعذر جلب القائمة. حاول مرة أخرى أو تأكد من الإنترنت.");
                return [];
            }
        }

        // تحميل الأقسام
        async function loadCategories(type) {
            lastCategoryType = type;
            let action = 'get_live_categories';
            if(type === 'movie') action = 'get_vod_categories';
            if(type === 'series') action = 'get_series_categories';

            const data = await apiCall(action);
            
            if(data && Array.isArray(data) && data.length > 0) {
                renderList(data, 'category');
                switchScreen('list-screen');
                currentLevel = 'categories';
            } else {
                alert("القائمة فارغة أو السيرفر لا يستجيب.");
            }
        }

        // تحميل القنوات
        async function loadChannels(categoryId) {
            let action = 'get_live_streams';
            let catParam = `&category_id=${categoryId}`;
            
            if(lastCategoryType === 'movie') action = 'get_vod_streams';
            if(lastCategoryType === 'series') action = 'get_series';

            const data = await apiCall(action, catParam);
            
            if(data && Array.isArray(data) && data.length > 0) {
                renderList(data, 'channel');
                currentLevel = 'channels';
                document.getElementById('list-title').innerText = "اختر المحتوى";
            } else {
                alert("لا يوجد محتوى في هذا القسم.");
            }
        }

        // الرسم على الشاشة
        function renderList(data, type) {
            const container = document.getElementById('list-content');
            container.innerHTML = '';

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.tabIndex = 0; 
                
                if (type === 'category') {
                    div.innerText = item.category_name || item.name; // التعامل مع تسميات مختلفة
                    div.onclick = () => loadChannels(item.category_id);
                } else {
                    div.innerText = item.name;
                    let streamId = item.stream_id || item.series_id;
                    let extension = item.container_extension || 'ts';
                    if(lastCategoryType === 'live') extension = 'm3u8'; 
                    
                    div.onclick = () => playStream(streamId, extension);
                }
                container.appendChild(div);
            });
            
            if(container.firstChild) container.firstChild.focus();
        }

        // التشغيل
        function playStream(streamId, ext) {
            switchScreen('player-screen');
            currentLevel = 'player';
            
            const video = document.getElementById('videoPlayer');
            let streamUrl = '';

            // رابط مباشر (بدون بروكسي لأن الفيديو يحتاج سرعة)
            // ملاحظة: قد يحتاج المتصفح لسماح insecure content
            if (lastCategoryType === 'live') {
                streamUrl = `${CONFIG.host}/live/${CONFIG.user}/${CONFIG.pass}/${streamId}.m3u8`;
            } else if (lastCategoryType === 'movie') {
                streamUrl = `${CONFIG.host}/movie/${CONFIG.user}/${CONFIG.pass}/${streamId}.${ext}`;
            } else {
                streamUrl = `${CONFIG.host}/series/${CONFIG.user}/${CONFIG.pass}/${streamId}.${ext}`;
            }

            if (Hls.isSupported() && lastCategoryType === 'live') {
                hls = new Hls();
                hls.loadSource(streamUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, function() { video.play(); });
            } else {
                video.src = streamUrl;
                video.play();
            }
        }

        function stopPlayer() {
            const video = document.getElementById('videoPlayer');
            video.pause();
            video.src = "";
            if(hls) { hls.destroy(); hls = null; }
            goBack();
        }

        // التنقل والرجوع الذكي
        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function goBack() {
            if (currentLevel === 'player') {
                stopPlayer(); 
                switchScreen('list-screen');
                currentLevel = 'channels';
            } else if (currentLevel === 'channels') {
                loadCategories(lastCategoryType); 
            } else if (currentLevel === 'categories') {
                switchScreen('home-screen');
                currentLevel = 'home';
                document.querySelector('.card').focus();
            }
        }

        // زر الرجوع في الريموت
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Backspace' || event.key === 'Escape') {
                event.preventDefault(); 
                if (currentLevel !== 'home') goBack();
            }
        });

    </script>
</body>
</html>
