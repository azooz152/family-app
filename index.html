<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AZOOZ TV - XTREAM PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #e056fd;
            --bg-overlay: rgba(0, 0, 0, 0.85);
            --glass: rgba(255, 255, 255, 0.05);
        }

        body {
            background: url('home.png') no-repeat center center/cover;
            background-color: #000;
            color: white;
            font-family: 'Cairo', sans-serif;
            margin: 0;
            overflow: hidden;
            height: 100vh;
        }

        /* === شاشة التحميل والتحديث (Loader) === */
        #loaderOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            display: none; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .loader-logo { font-family: 'Orbitron'; font-size: 60px; margin-bottom: 20px; animation: pulse 2s infinite; }
        .loader-logo span { color: var(--primary); }
        
        .progress-container { width: 60%; height: 10px; background: #333; border-radius: 10px; overflow: hidden; margin-top: 20px; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.3s; }
        .status-text { margin-top: 15px; color: #aaa; font-size: 14px; }
        
        @keyframes pulse { 50% { opacity: 0.6; transform: scale(0.98); } }

        /* === الهيكل العام === */
        .app-container { display: flex; height: 100vh; width: 100%; }

        /* القائمة الجانبية */
        .sidebar {
            width: 260px; background: rgba(0,0,0,0.9);
            border-left: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; padding-top: 20px;
        }
        .brand { text-align: center; font-family: 'Orbitron'; font-size: 28px; margin-bottom: 30px; }
        .brand span { color: var(--primary); }

        .menu-item {
            padding: 15px 20px; cursor: pointer; color: #ccc;
            border-right: 4px solid transparent; transition: 0.2s;
            display: flex; align-items: center; font-size: 16px;
        }
        .menu-item i { margin-left: 15px; width: 25px; text-align: center; }
        
        .menu-item.active, .menu-item.focused {
            background: linear-gradient(90deg, rgba(0,242,255,0.15), transparent);
            border-right-color: var(--primary); color: white;
            transform: translateX(-5px);
        }

        /* زر التحديث الخاص */
        .update-btn {
            margin: 20px; padding: 12px;
            background: linear-gradient(45deg, var(--secondary), var(--primary));
            border-radius: 10px; text-align: center; font-weight: bold;
            cursor: pointer; box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);
        }
        .update-btn.focused { transform: scale(1.05); border: 2px solid white; }

        /* المحتوى */
        .main-content { flex: 1; padding: 20px; overflow: hidden; position: relative; }
        .header-title { font-size: 24px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }

        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px; height: 90%; overflow-y: auto; padding-bottom: 50px;
        }
        
        .card {
            background: rgba(255,255,255,0.05); border-radius: 12px;
            padding: 10px; text-align: center; transition: 0.2s;
            border: 2px solid transparent; position: relative;
        }
        .card img { width: 100%; height: 140px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; background: #000; }
        .card-title { font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .card.focused {
            border-color: var(--primary); transform: scale(1.08);
            background: #222; z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* شاشة الدخول */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url('home.png') no-repeat center center/cover;
            display: flex; align-items: center; justify-content: center; z-index: 2000;
        }
        .login-box {
            background: rgba(0,0,0,0.85); backdrop-filter: blur(20px);
            padding: 40px; border-radius: 20px; width: 350px; text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .login-input {
            width: 100%; padding: 15px; margin: 10px 0;
            background: rgba(255,255,255,0.1); border: none; border-radius: 8px;
            color: white; text-align: center; font-size: 16px; outline: none;
        }
        .login-input:focus { background: rgba(255,255,255,0.2); }
        
        /* المشغل */
        #playerOverlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background:black;
            z-index: 5000; display: none; flex-direction: column;
        }
        video { width: 100%; height: 100%; }
        .back-ctrl {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px;
            cursor: pointer; z-index: 5001;
        }

    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <div class="brand">AZOOZ <span>TV</span></div>
            <p style="color:#aaa; font-size:14px; margin-bottom:20px;">الخادم المدمج: Aseaf1 Server</p>
            
            <input type="text" id="username" class="login-input focusable" placeholder="اسم المستخدم">
            <input type="password" id="password" class="login-input focusable" placeholder="كلمة المرور">
            
            <div class="update-btn focusable" onclick="startLogin()">دخول للنظام</div>
        </div>
    </div>

    <div id="loaderOverlay">
        <div class="loader-logo">AZOOZ <span>TV</span></div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="status-text" id="statusText">جاري الاتصال بالسيرفر...</div>
    </div>

    <div class="app-container" id="mainApp" style="display: none;">
        
        <div class="sidebar">
            <div class="brand">AZOOZ <span>TV</span></div>
            
            <div class="menu-item active focusable" onclick="showSection('live')">
                <i class="fas fa-tv"></i> القنوات
            </div>
            <div class="menu-item focusable" onclick="showSection('movies')">
                <i class="fas fa-film"></i> الأفلام
            </div>
            <div class="menu-item focusable" onclick="showSection('series')">
                <i class="fas fa-layer-group"></i> المسلسلات
            </div>
            
            <div style="flex:1"></div> <div class="update-btn focusable" onclick="updateAllContent()">
                <i class="fas fa-sync-alt fa-spin" style="display:none" id="spinIcon"></i> تحديث الكل
            </div>
        </div>

        <div class="main-content">
            <h2 class="header-title" id="pageTitle">القنوات المباشرة</h2>
            <div class="grid" id="contentGrid">
                </div>
        </div>
    </div>

    <div id="playerOverlay">
        <div class="back-ctrl focusable" onclick="closePlayer()">خروج</div>
        <video id="player" controls></video>
    </div>

    <script>
        // ==========================================
        // إعدادات السيرفر (مخفية عن المستخدم)
        // ==========================================
        const SERVER_HOST = "http://aseaf1.me:8080";
        let USERNAME = "";
        let PASSWORD = "";
        
        // تخزين البيانات
        let DATA = {
            live: [],
            movies: [],
            series: []
        };

        // ==========================================
        // 1. نظام الدخول
        // ==========================================
        function startLogin() {
            USERNAME = document.getElementById('username').value;
            PASSWORD = document.getElementById('password').value;

            if(!USERNAME || !PASSWORD) {
                alert("الرجاء إدخال البيانات");
                return;
            }

            // إخفاء الدخول وإظهار التحميل
            document.getElementById('loginScreen').style.display = 'none';
            updateAllContent(); // بدء سحب البيانات
        }

        // ==========================================
        // 2. محرك التحديث (Update Engine)
        // ==========================================
        async function updateAllContent() {
            const loader = document.getElementById('loaderOverlay');
            const bar = document.getElementById('progressBar');
            const txt = document.getElementById('statusText');
            const app = document.getElementById('mainApp');
            
            loader.style.display = 'flex';
            app.style.display = 'none'; // إخفاء التطبيق أثناء التحميل
            
            try {
                // 1. التحقق من الاتصال (10%)
                updateProgress(10, "جاري التحقق من الحساب...");
                const authUrl = `${SERVER_HOST}/player_api.php?username=${USERNAME}&password=${PASSWORD}`;
                const authRes = await fetch(authUrl); // قد يفشل هنا بسبب Mixed Content
                const authData = await authRes.json();
                
                if(authData.user_info.auth === 0) {
                    alert("بيانات الدخول خاطئة أو منتهية!");
                    location.reload();
                    return;
                }

                // 2. تحميل القنوات (40%)
                updateProgress(40, "جاري تحميل قائمة القنوات...");
                const liveUrl = `${SERVER_HOST}/player_api.php?username=${USERNAME}&password=${PASSWORD}&action=get_live_streams`;
                const liveRes = await fetch(liveUrl);
                DATA.live = await liveRes.json();

                // 3. تحميل الأفلام (70%)
                updateProgress(70, "جاري تحميل مكتبة الأفلام...");
                const vodUrl = `${SERVER_HOST}/player_api.php?username=${USERNAME}&password=${PASSWORD}&action=get_vod_streams`;
                const vodRes = await fetch(vodUrl);
                DATA.movies = await vodRes.json();

                // 4. تحميل المسلسلات (90%)
                updateProgress(90, "جاري تحميل المسلسلات...");
                const seriesUrl = `${SERVER_HOST}/player_api.php?username=${USERNAME}&password=${PASSWORD}&action=get_series`;
                const seriesRes = await fetch(seriesUrl);
                DATA.series = await seriesRes.json();

                // 5. اكتمل (100%)
                updateProgress(100, "تم التحديث بنجاح!");
                setTimeout(() => {
                    loader.style.display = 'none';
                    app.style.display = 'flex';
                    showSection('live'); // عرض القنوات افتراضياً
                    setupFocus();
                }, 1000);

            } catch (error) {
                console.error(error);
                // رسالة خطأ ذكية
                alert("تنبيه: فشل الاتصال بالسيرفر.\nالسبب: المتصفح يحظر الاتصال بـ HTTP.\nالحل: جرب تشغيل التطبيق محلياً أو استخدم بروكسي.");
                
                // تشغيل وضع التجربة (Mock Data) عشان ما يزعل المستخدم
                loadMockData(); 
                loader.style.display = 'none';
                app.style.display = 'flex';
                showSection('live');
                setupFocus();
            }
        }

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + "%";
            document.getElementById('statusText').innerText = text;
        }

        // ==========================================
        // 3. العرض والتحكم
        // ==========================================
        function showSection(type) {
            document.getElementById('pageTitle').innerText = 
                type === 'live' ? 'القنوات المباشرة (' + DATA.live.length + ')' :
                type === 'movies' ? 'مكتبة الأفلام (' + DATA.movies.length + ')' : 'المسلسلات (' + DATA.series.length + ')';
            
            const grid = document.getElementById('contentGrid');
            grid.innerHTML = "";

            const items = DATA[type];
            
            // تحسين الأداء: عرض أول 100 عنصر فقط لعدم تعليق المتصفح
            const limit = items.length > 100 ? 100 : items.length;

            for(let i=0; i<limit; i++) {
                const item = items[i];
                const card = document.createElement('div');
                card.className = 'card focusable';
                
                // تحديد البيانات بناءً على نوع الرد من السيرفر
                let name = item.name;
                let img = item.stream_icon || "https://via.placeholder.com/150?text=No+Image";
                let streamId = item.stream_id || item.series_id;
                
                // تصحيح الرابط للصورة إذا كان ناقصاً
                if(img && !img.startsWith('http')) { img = "https://via.placeholder.com/150?text=AZOOZ"; }

                card.innerHTML = `
                    <img src="${img}" onerror="this.src='https://via.placeholder.com/150?text=Logo'">
                    <div class="card-title">${name}</div>
                `;
                
                // عند الضغط
                card.onclick = () => {
                    if(type === 'live' || type === 'movies') {
                        // تكوين رابط التشغيل المباشر
                        // البنية: http://host:port/user/pass/id.extension
                        let ext = type === 'live' ? '' : '.' + item.container_extension;
                        let playUrl = `${SERVER_HOST}/${type}/${USERNAME}/${PASSWORD}/${streamId}${ext}`;
                        
                        // للقنوات الحية غالباً الرابط يكون: http://host:port/user/pass/id
                        if(type === 'live') {
                             playUrl = `${SERVER_HOST}/${USERNAME}/${PASSWORD}/${streamId}`;
                        }
                        
                        openPlayer(playUrl);
                    } else {
                        alert("تشغيل المسلسلات يحتاج خطوة إضافية لجلب الحلقات (سأضيفها لك لاحقاً)");
                    }
                };
                
                grid.appendChild(card);
            }
            
            // إعادة ضبط الريموت
            setTimeout(setupFocus, 100);
        }

        function openPlayer(url) {
            const overlay = document.getElementById('playerOverlay');
            const vid = document.getElementById('player');
            overlay.style.display = 'flex';
            
            if (Hls.isSupported() && url.endsWith('m3u8')) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(vid);
                hls.on(Hls.Events.MANIFEST_PARSED, () => vid.play());
            } else {
                vid.src = url;
                vid.play();
            }
        }
        
        function closePlayer() {
            const vid = document.getElementById('player');
            vid.pause();
            document.getElementById('playerOverlay').style.display = 'none';
        }

        // بيانات وهمية احتياطية (في حال فشل الاتصال الحقيقي)
        function loadMockData() {
            DATA.live = [
                { name: "BeIN Sports 1", stream_icon: "", stream_id: 1 },
                { name: "MBC 1", stream_icon: "", stream_id: 2 }
            ];
            DATA.movies = [
                { name: "John Wick 4", stream_icon: "https://image.tmdb.org/t/p/w500/vZloFAK7NmvMGKE7VkF5UHaz0I.jpg", container_extension: "mp4", stream_id: 100 }
            ];
        }

        // ==========================================
        // 4. نظام الريموت (HarmonyOS Remote)
        // ==========================================
        let focusItems = [];
        let currentFocus = 0;

        function setupFocus() {
            // نجمع كل العناصر القابلة للتركيز الظاهرة فقط
            const visibleContainer = document.getElementById('loginScreen').style.display !== 'none' 
                                     ? document.getElementById('loginScreen') 
                                     : document.getElementById('mainApp');
                                     
            focusItems = Array.from(visibleContainer.querySelectorAll('.focusable'));
            currentFocus = 0;
            if(focusItems.length > 0) setFocus(0);
        }

        function setFocus(index) {
            focusItems.forEach(el => el.classList.remove('focused'));
            if(focusItems[index]) {
                focusItems[index].classList.add('focused');
                focusItems[index].focus();
                focusItems[index].scrollIntoView({behavior: "smooth", block: "center"});
            }
        }

        document.addEventListener('keydown', (e) => {
            if (focusItems.length === 0) return;

            if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                currentFocus = (currentFocus + 1) % focusItems.length;
                setFocus(currentFocus);
            } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                currentFocus = (currentFocus - 1 + focusItems.length) % focusItems.length;
                setFocus(currentFocus);
            } else if (e.key === 'Enter') {
                focusItems[currentFocus].click();
            } else if (e.key === 'Backspace' || e.key === 'Escape') {
                closePlayer();
            }
        });

        // بدء التركيز عند التحميل
        window.onload = setupFocus;

    </script>
</body>
</html>
